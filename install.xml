<?xml version="1.0" encoding="utf-8"?>
<modification>
  <name>Omnivalt Shipping Mod Default</name>
  <version>1.0</version>
  <author>Mijora</author>
  <link>https://www.mijora.lt</link>
  <code>omnivaltshipping</code>

  <file path="catalog/view/theme/*/template/common/header.twig" error="log">
    <operation>
      <search><![CDATA[</head>]]></search>
      <add position="before"><![CDATA[
<link href="catalog/view/javascript/omnivalt/leaflet.css" rel="stylesheet">
<link href="catalog/view/javascript/omnivalt/omniva-map.css" rel="stylesheet">
<link href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" rel="stylesheet">
<script defer src="catalog/view/javascript/omnivalt/leaflet.js" type="text/javascript"></script>
<script defer src="catalog/view/javascript/omnivalt/omniva-map.min.js" type="text/javascript"></script>
        ]]>
      </add>
    </operation>
  </file>

  <file path="admin/controller/common/column_left.php">
    <operation>
      <search><![CDATA[if ($marketplace) {	]]></search>
      <add position="before"><![CDATA[   
        $omniva = array();
        $this->load->language('extension/shipping/omnivalt');                 
			  if ($this->user->hasPermission('access', 'extension/omnivalt/omnivalt')) {        
          $omniva[] = array(
            'name'     => $this->language->get('menu_manifest'),
            'href'     => $this->url->link('extension/omnivalt/omnivalt', 'user_token=' . $this->session->data['user_token'], true),
            'children' => array()      
          );                  
			  }
			  if ($this->user->hasPermission('access', 'extension/shipping/omnivalt')) {        
          $omniva[] = array(
            'name'     => $this->language->get('menu_settings'),
            'href'     => $this->url->link('extension/shipping/omnivalt', 'user_token=' . $this->session->data['user_token'], true),
            'children' => array()      
          );                  
			  }					
			  if ($this->user->hasPermission('access', 'extension/shipping/omnivalt')) {
          $marketplace[] = array(
            'name'     => $this->language->get('menu_head'),
            'href'     => '',
            'children' => $omniva
          );
			  }
        ]]>
      </add>
    </operation>
  </file>

  <file name="admin/controller/sale/order.php">
    <operation>
      <search position="after"><![CDATA[
        $data['shipping'] = $this->url->link('sale/order/shipping', 'user_token=' . $this->session->data['user_token'], true);
        ]]>
      </search>
      <add><![CDATA[
        $data['omnivalt_label'] = $this->url->link('extension/omnivalt/omnivaltPrints/labels', 'user_token=' . $this->session->data['user_token'], true);
        $this->load->language('extension/shipping/omnivalt');
        $data['generate_labels']   =$this->language->get('generate_labels');
        $data['text_manifest']   =$this->language->get('print_manifest');
        $data['omnivalt_manifest'] = $this->url->link('extension/omnivalt/omnivaltPrints/manifest', 'user_token=' . $this->session->data['user_token'], true);   
        ]]>
      </add>
    </operation>

    <operation>
      <search position="after"><![CDATA[
        $data['invoice'] = $this->url->link('sale/order/invoice', 'user_token=' . $this->session->data['user_token'] . '&order_id=' . (int)$this->request->get['order_id'], true);		
        ]]>
      </search>
      <add><![CDATA[
        $data['omnivalt_label'] = $this->url->link('extension/omnivalt/omnivaltPrints/labels', 'user_token=' . $this->session->data['user_token'] . '&order_id=' . (int)$this->request->get['order_id'], true);		    
        $data['omnivalt_label_print'] = $this->url->link('extension/omnivalt/omnivaltPrints/labelsprint', 'user_token=' . $this->session->data['user_token'] . '&order_id=' . (int)$this->request->get['order_id'], true);		              
        ]]>
      </add>
    </operation>

    <operation>
      <search position="after"><![CDATA[$data['payment_method'] = $order_info['payment_method'];]]></search>
      <add><![CDATA[
        /* Additional field */
        $data['orderCarrier'] = $order_info['shipping_code'];
        $data['labelsCount'] = $order_info['labelsCount'];
        $data['omnivaWeight'] = $order_info['omnivaWeight'];
        $data['cod_amount'] = $order_info['cod_amount'];
        $data['omniva_terminals'] = $this->config->get('omnivalt_terminals_LT');
        $data['shipping_code'] = $order_info['shipping_code'];
        $data['editOmniva'] = $this->url->link('extension/omnivalt/omnivaltPrints/editLabel', 'user_token=' . $this->session->data['user_token']. '&order_id='.$data['order_id'], true);
        $data['payment_code'] = $order_info['payment_code'];
        /* $data['orderTotal'] = $order_info['total']; */
        $data['orderTotal'] = floatval($this->currency->format($order_info['total'], $this->config->get('config_currency')));

        $data['parcel_terminals'] = null;
        if(substr($order_info['shipping_code'], 0, 8) == 'omnivalt') {
          $omniva_terminals = $this->config->get('omnivalt_terminals_LT');
          $grouped_options = array();
          $parcel_terminals = '';
          $shipping_code = $order_info['shipping_code'];
          foreach ($omniva_terminals as $terminal){
            if (!isset($grouped_options[$terminal[1]]))
              $grouped_options[(string)$terminal[1]] = array();
            $grouped_options[(string)$terminal[1]][(string)$terminal[3]] = $terminal[0].', '.$terminal[2];  
          }
          foreach ($grouped_options as $city=>$locs){
            $parcel_terminals .= '<optgroup label = "'.$city.'">';
            foreach ($locs as $key=>$loc){
              $parcel_terminals .= '<option value = "omnivalt.parcel_terminal_'.$key.'|'.$loc.'" '.('omnivalt.parcel_terminal_'.$key == $shipping_code ?'selected':'').'>'.$loc.'</option>';
            }
            $parcel_terminals .= '</optgroup>';
          }
          if ($parcel_terminals != '')
          $data['parcel_terminals'] = $parcel_terminals;
        }

        $this->load->language('extension/shipping/omnivalt');
        $data['labels_count']   =$this->language->get('labels_count');
        $data['weight']   =$this->language->get('weight');
        $data['delivery_method']   =$this->language->get('delivery_method');
        $data['generate_labels']   =$this->language->get('generate_labels');
        $data['text_cod_amount']   =$this->language->get('cod_amount');
        $data['generate_label']   =$this->language->get('generate_label');
        $data['renew']   =$this->language->get('renew');
        ]]>
      </add>
    </operation>
  </file>

  <file name="admin/view/template/sale/order_info.twig">
    <operation>
      <search position="before"><![CDATA[
        <a href="{{ invoice }}" target="_blank" data-toggle="tooltip" title="{{ button_invoice_print }}" class="btn btn-info"><i class="fa fa-print"></i></a>            ]]>
      </search>
      <add><![CDATA[
        <a href="{{ omnivalt_label }}" target="_blank" data-toggle="tooltip" title="{{ generate_labels }}" class="btn btn-warning"><i class="fa fa-barcode"></i></a>
        ]]>
      </add>
    </operation>

    <operation>
      <search position="before"><![CDATA[<h3 class="panel-title"><i class="fa fa-user"></i> {{ text_customer_detail }}</h3>]]></search>
      <add><![CDATA[
        {% if 'omnivalt' in orderCarrier %}
        <form method="POST" action="{{ editOmniva }}">
          <input type="hidden" value="{{ order_id }}" name="order_id">
          <h3 class="panel-title"><i class="fa fa-info-circle"></i> {{ heading_title }}</h3>
        </div>
        <table class="table">
          <tbody>
            <tr>
              <td colspan="2">{{labels_count }}
                <select name="labelsCount" id="labelsCount" class="form-control input-sm">
                  <option value="1" selected="">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                </select>
              </td>
              <td colspan="2">
                {{ weight }} <input type="number" step="0.0001" name="omnivaWeight" class="form-control input-sm" value="{{ omnivaWeight }}">
              </td>
            </tr>
            <tr>
              <td colspan="2">C.O.D 
                <select name="cod_available" class="form-control input-sm">
                  <option value="0">Ne</option>
                  <option value="1" {% if (payment_code == 'cod' or cod_amount > 0) and cod_amount != 888888 %} selected="" {% endif %}>Taip</option>
                </select>
              </td>
              <td colspan="2">
                {{text_cod_amount }}
                <input type="text" name="cod_value" class="form-control input-sm" value="{% if cod_amount and cod_amount != 888888 %} {{ cod_amount }} {% else %} {{ orderTotal }} {% endif %}">
              </td>
            </tr>
            <tr>
              <td colspan="4">{{delivery_method }}
                <select name="delivery_method" class="form-control input-sm">
                  <option disabled>Select labels count</option>
                  <option value="omnivalt.courier|OmnivaLt kurjeris">Omnivalt Courier</option>
                  {{ parcel_terminals }}
                </select>
              </td>
            </tr>
          </tbody>
        </table>
        <input type="submit" name="update" class="btn btn-default btn-sm" value="{{renew }}">
        <input type="submit" name="generateLabel" class="btn btn-default btn-sm" value="{{generate_label }}">
        </div>
        </form>
        <div class="panel panel-default">
        <div class="panel-heading">
        {% endif %}
        ]]>
      </add>
    </operation>
  </file>

  <file name="admin/view/template/sale/order_list.twig">
    <operation>
      <search position="before"><![CDATA[<button type="button" data-toggle="tooltip" title="{{ button_filter }}"]]></search>
      <add><![CDATA[
        <button type="submit" id="button-omnivalt-labels" form="form-order" formaction="{{ omnivalt_label }}" formtarget="_blank" data-toggle="tooltip" title="{{ generate_labels }}" class="btn btn-warning"><i class="fa fa-barcode"></i></button>
        <button type="submit" id="button-omnivalt-manifests" form="form-order" formaction="{{ omnivalt_manifest }}" formtarget="_blank" data-toggle="tooltip" title="{{ text_manifest }}" class="btn btn-info"><i class="fa fa-file-text"></i></button>
        ]]>
      </add>
    </operation>

    <operation>
      <search position="after"><![CDATA[<td class="text-left">{{ order.customer }}]]></search>
      <add><![CDATA[
        {% if 'omnivalt' in order["shipping_code"] %}
        <img src="./view/image/omniva-lt.png" alt="Omniva LT" height="20">
        {% endif %}
        ]]>
      </add>
    </operation>
  </file>

  <file name="admin/model/sale/order.php">
    <operation>
      <search position="after"><![CDATA[ $order_query->row['date_modified']]]></search>
      <add><![CDATA[
        ,'labelsCount'           => $order_query->row['labelsCount'],
        'omnivaWeight'           => $order_query->row['omnivaWeight'],
        'cod_amount'             => $order_query->row['cod_amount'],
        'omniva_image_url'       => HTTPS_SERVER . 'view/image/omniva-lt.png'
        ]]>
      </add>
    </operation>
  </file>

</modification>